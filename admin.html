<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>RightClick Admin Panel</title>
  <link rel="stylesheet" href="style.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<h2>RightClick Computer Sales & Service Center</h2>
<h3>Admin Panel - Job Status Tracker</h3>

<input type="text" id="searchInput" placeholder="Search by Job ID or Customer Name">

<table border="1" id="jobsTable">
  <thead>
    <tr>
      <th>Job ID</th>
      <th>Customer Name</th>
      <th>Mobile</th>
      <th>Item</th>
      <th>Status</th>
      <th>Update Status</th>
    </tr>
  </thead>
  <tbody id="jobsBody">
    <!-- Jobs will appear here -->
  </tbody>
</table>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { 
  getFirestore,
  collection,
  doc,
  updateDoc,
  getDoc,
  onSnapshot
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyB8uRXxvOyZeCUzPEt-pUytXj_R8N_JLww",
  authDomain: "rightclick-service-center.firebaseapp.com",
  projectId: "rightclick-service-center",
  storageBucket: "rightclick-service-center.firebasestorage.app",
  messagingSenderId: "558210394752",
  appId: "1:558210394752:web:a3f8663d7c6dc8cc88d465"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const jobsBody = document.getElementById("jobsBody");
const searchInput = document.getElementById("searchInput");

/* ---------------- REALTIME LOADING ---------------- */
function loadJobsRealtime() {
  onSnapshot(collection(db, "jobs"), (snapshot) => {
    jobsBody.innerHTML = "";

    snapshot.forEach((docSnap) => {
      const job = docSnap.data();
      const row = document.createElement("tr");

      row.innerHTML = `
        <td>${job.jobId}</td>
        <td>${job.customerName}</td>
        <td>${job.mobile}</td>
        <td>${job.item}</td>
        <td id="status-${docSnap.id}">${job.status}</td>
        <td>
          <select id="select-${docSnap.id}">
            <option value="Received" ${job.status==="Received"?"selected":""}>Received</option>
            <option value="In Progress" ${job.status==="In Progress"?"selected":""}>In Progress</option>
            <option value="Ready" ${job.status==="Ready"?"selected":""}>Ready</option>
            <option value="Delivered" ${job.status==="Delivered"?"selected":""}>Delivered</option>
          </select>
          <button onclick="updateStatus('${docSnap.id}')">Update</button>
        </td>
      `;
      jobsBody.appendChild(row);
    });
  });
}

/* ---------------- UPDATE STATUS + WHATSAPP ---------------- */
window.updateStatus = async function(docId) {
  const select = document.getElementById(`select-${docId}`);
  const newStatus = select.value;
  const docRef = doc(db, "jobs", docId);

  await updateDoc(docRef, { status: newStatus });
  document.getElementById(`status-${docId}`).innerText = newStatus;

  const jobDoc = await getDoc(docRef);
  const job = jobDoc.data();

  let message = "";

  if (newStatus === "Received") {
    message = `RightClick Computer Sales & Service Center

Your device has been received successfully.
Job ID: ${job.jobId}`;
  }
  else if (newStatus === "In Progress") {
    message = `RightClick Computer Sales & Service Center

Your device is currently under service.
Job ID: ${job.jobId}`;
  }
  else if (newStatus === "Ready") {
    message = `RightClick Computer Sales & Service Center

Your device is ready for pickup.
Job ID: ${job.jobId}
Please visit our store.`;
  }
  else if (newStatus === "Delivered") {
    message = `RightClick Computer Sales & Service Center

Your device has been delivered successfully.
Job ID: ${job.jobId}
Thank you for choosing RightClick.`;
  }

  if (message !== "") {
    let customerNumber = job.mobile;
    if (!customerNumber.startsWith("91")) {
      customerNumber = "91" + customerNumber;
    }

    const whatsappUrl = `https://wa.me/${customerNumber}?text=${encodeURIComponent(message)}`;
    window.open(whatsappUrl, "_blank");
  }

  alert("Status updated to: " + newStatus);
};

/* ---------------- SEARCH ---------------- */
searchInput.addEventListener("input", () => {
  const filter = searchInput.value.toLowerCase();
  const rows = jobsBody.getElementsByTagName("tr");
  for (let i = 0; i < rows.length; i++) {
    const text = rows[i].innerText.toLowerCase();
    rows[i].style.display = text.includes(filter) ? "" : "none";
  }
});

/* Start realtime listener */
loadJobsRealtime();
</script>

</body>
</html>
